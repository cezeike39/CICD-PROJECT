name: Deploy to Kops Kubernetes

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    env:
      KOPS_CLUSTER_NAME: cezeike39.k8s.local
      AWS_REGION: us-east-1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Install kops
      run: |
        curl -LO https://github.com/kubernetes/kops/releases/latest/download/kops-linux-amd64
        chmod +x kops-linux-amd64
        sudo mv kops-linux-amd64 /usr/local/bin/kops

    - name: Export kubeconfig from Kops
      run: |
        kops export kubeconfig --name $KOPS_CLUSTER_NAME --state s3://your-kops-state-store --admin

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/cicd-cm.yaml
        kubectl apply -f k8s/cicd-secret.yaml
        kubectl apply -f k8s/mongo-cicd.yaml
        kubectl apply -f k8s/cicd-deploy.yaml
